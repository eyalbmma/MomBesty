import csv, random, re

random.seed(42)

def clean(s: str) -> str:
    return re.sub(r"\s+", " ", s).strip()

AGES = ["יומיים","שלושה ימים","חמישה ימים","שבוע","שבוע וחצי","שבועיים","שלושה שבועות","חודש","שישה שבועות"]
TIMES = ["בלילה","בערב","בבוקר","אחר הצהריים","אחרי האמבטיה","אחרי האכלה"]
CRY = ["בוכה הרבה","בוכה בהיסטריה","נרגע רק על הידיים","בוכה בעיקר בערב","מתפתל ובוכה"]
STOOL = ["צהוב חרדלי","ירקרק","חום","כהה מאוד","מעט רירי"]
SKIN = ["פריחה אדומה","יובש בעור","אקנה של תינוקות","קילופים","אדמומיות בקפלים"]
MOM = ["מוצפת","עייפה מאוד","בוכה בלי סיבה","מרגישה לבד","לחוצה"]
CTX = ["ילד ראשון","בלילה","בערב","אחרי האכלה","אחרי לידה","כשאני לבד בבית","בהאכלה משולבת","עם הנקה","עם בקבוק","בימים הראשונים","כשיש הרבה אורחים","בזמן נסיעה"]

PREF = [
    "זה נפוץ מאוד בשבועות הראשונים.",
    "בהרבה מקרים זה חלק מההסתגלות של התינוק והגוף שלך.",
    "בימים הראשונים יש הרבה חוסר ודאות, וזה לגמרי מובן.",
    "זה יכול להיות תקין, אבל שווה לשים לב לסימנים נוספים."
]
DO = ["מה אפשר לעשות עכשיו: ","מה כדאי לנסות עכשיו: ","צעדים פשוטים לעכשיו: ","כמה דברים פרקטיים לעכשיו: "]
DOC = [
    "מתי לפנות לרופא/ה: אם יש חום, ישנוניות חריגה, קושי נשימתי, סימני התייבשות או משהו שמדאיג אותך.",
    "פני לבדיקה רפואית אם יש חום, ירידה חדה בערנות, הקאות מרובות, או אם האינטואיציה אומרת שמשהו לא בסדר.",
    "מומלץ לפנות לרופא/ה אם יש חום, פחות חיתולים רטובים מהרגיל, צהבת שמחמירה, או בכי בלתי פוסק שאי אפשר להרגיע."
]
SAFETY = "זה מידע כללי ולא תחליף לייעוץ רפואי אישי."
SOURCE = "Generated newborn & postpartum Q&A (for RAG; general info)"

EXTRA = [
    "אם יש ספק, יומן קצר של האכלות/חיתולים עוזר בשיחה עם אנשי מקצוע.",
    "לפעמים שינוי קטן בסביבה (אור/רעש) עושה הבדל גדול.",
    "להוריד ציפיות ולבקש עזרה מעשית — זה לגיטימי לגמרי.",
    "אם משהו מרגיש לך לא נכון — עדיף להתייעץ."
]

def answer(steps):
    a = " ".join([random.choice(PREF), random.choice(DO) + " ".join(steps), random.choice(DOC), SAFETY])
    if random.random() < 0.33:
        a += " " + random.choice(EXTRA)
    return clean(a)

def make_one():
    age = random.choice(AGES)

    # בוחרים נושא
    topic = random.choice([
        "feed_freq","enough_milk","cluster","sleep_hours","safe_sleep","cry_evening","gas","spitup","fever",
        "jaundice","diapers","stool_color","umbilical","bath","skin","diaper_rash",
        "breast_pain","engorgement","mastitis","post_bleed","post_mood","csection","stitches","mom_sleep","bottle"
    ])

    if topic == "feed_freq":
        q = f"התינוק בן {age} — כל כמה זמן כדאי להאכיל?"
        steps = [
            "להציע האכלה כל 2–3 שעות או לפי סימני רעב (חיפוש פטמה, מציצה, אי שקט).",
            "לבדוק שיש מספיק חיתולים רטובים ומעקב משקל תקין.",
            "אם קשה להעיר — לנסות עור-לעור ושינוי תנוחה."
        ]
        tags = "האכלה,ניובורן"

    elif topic == "enough_milk":
        q = f"איך יודעים אם תינוק בן {age} מקבל מספיק חלב?"
        steps = [
            "להסתכל על חיתולים רטובים ויציאות לאורך היום.",
            "לשים לב לבליעות בזמן האכלה ולרוגע אחרי.",
            "אם יש ספק — מעקב בטיפת חלב יכול להרגיע."
        ]
        tags = "הנקה,חיתולים,ניובורן"

    elif topic == "cluster":
        q = f"התינוק בן {age} מבקש לאכול רצוף {random.choice(TIMES)} — זה תקין?"
        steps = [
            "כן, זה יכול לקרות בתקופות גדילה ('האכלה מצטברת').",
            "להקפיד על גיהוקים והפסקות קצרות.",
            "לנסות לדאוג גם לשתייה ומנוחה שלך."
        ]
        tags = "האכלה,ניובורן"

    elif topic == "sleep_hours":
        q = f"כמה שעות שינה ביום נחשב תקין לתינוק בן {age}?"
        steps = [
            "לרוב 14–17 שעות ביממה, במקטעים קצרים.",
            "יום/לילה מסתדרים בהדרגה.",
            "שגרה עדינה: אור ביום וחושך בלילה יכולה לעזור."
        ]
        tags = "שינה,ניובורן"

    elif topic == "safe_sleep":
        q = f"מה כללי הבטיחות לשינה לתינוק בן {age}?"
        steps = [
            "על הגב, על מזרן קשיח, בלי כריות/שמיכות רופפות.",
            "טמפרטורה נעימה ומאוורר.",
            "שק שינה מתאים עדיף משמיכה."
        ]
        tags = "שינה,בטיחות,ניובורן"

    elif topic == "cry_evening":
        q = f"התינוק בן {age} {random.choice(CRY)} בעיקר בערב — מה עושים?"
        steps = [
            "לבדוק: רעב, חיתול, עייפות, גזים.",
            "לנסות: עור-לעור, נענוע עדין, רעש לבן, מוצץ אם מתאים.",
            "להקטין גירויים בשעות הערב."
        ]
        tags = "בכי,ניובורן"

    elif topic == "gas":
        q = f"גזים לתינוק בן {age}: איך אפשר להקל?"
        steps = [
            "גיהוק באמצע ובסוף האכלה.",
            "עיסוי עדין בבטן ותנועות 'אופניים' לרגליים.",
            "להחזיק זקוף כמה דקות אחרי האכלה."
        ]
        tags = "עיכול,בכי,ניובורן"

    elif topic == "spitup":
        q = f"התינוק בן {age} פולט אחרי האכלה — מתי זה תקין ומתי לא?"
        steps = [
            "פליטות קטנות נפוצות במיוחד אם אכל מהר.",
            "להאכיל לאט יותר ולהשאיר זקוף אחרי האכלה.",
            "לעקוב אם יש ירידה במשקל/הקאות חזקות/סימני כאב."
        ]
        tags = "האכלה,בריאות,ניובורן"

    elif topic == "fever":
        q = f"מה עושים אם לתינוק בן {age} יש חום?"
        steps = [
            "לא לתת תרופות בלי הנחיה רפואית.",
            "להציע האכלה לעיתים קרובות ולהלביש קל.",
            "למדוד עם מדחום אמין ולתעד."
        ]
        tags = "בריאות,רופא,ניובורן"

    elif topic == "jaundice":
        q = f"יש לתינוק בן {age} צהבת קלה בעור/בעיניים — מה חשוב לדעת?"
        steps = [
            "צהבת בימים הראשונים יכולה להיות שכיחה.",
            "לעקוב אחרי ערנות, האכלה וחיתולים.",
            "אם זה מחמיר או התינוק ישנוני מאוד — לבדיקה."
        ]
        tags = "בריאות,ניובורן"

    elif topic == "diapers":
        q = f"כמה חיתולים רטובים ויציאות מצפים לתינוק בן {age}?"
        steps = [
            "בדרך כלל כמות החיתולים הרטובים עולה בשבוע הראשון.",
            "מרקם/צבע יציאות משתנים לפי סוג הזנה.",
            "אם יש ירידה חדה בחיתולים רטובים — להתייעץ."
        ]
        tags = "חיתולים,בריאות,ניובורן"

    elif topic == "stool_color":
        q = f"היציאה של תינוק בן {age} בצבע {random.choice(STOOL)} — זה תקין?"
        steps = [
            "צבע היציאות משתנה מאוד בשבועות הראשונים.",
            "אם אין דם/חום והתינוק אוכל וערני — לרוב זה בסדר.",
            "אם יש סימני מחלה או דם — לבדיקה."
        ]
        tags = "חיתולים,עיכול,ניובורן"

    elif topic == "umbilical":
        q = f"מה לעשות עם חבל הטבור של תינוק בן {age} עד שהוא נופל?"
        steps = [
            "לשמור יבש ונקי, לא למשוך.",
            "לקפל חיתול מתחת לטבור כדי לא לשפשף.",
            "אם יש ריח חריף/אודם מתפשט/מוגלה — לבדיקה."
        ]
        tags = "טבור,ניובורן,בריאות"

    elif topic == "bath":
        q = f"מתי אפשר לעשות אמבטיה לתינוק בן {age}, ומה חשוב לשים לב?"
        steps = [
            "אמבטיה קצרה במים פושרים ובחדר חמים.",
            "סבון עדין במידת הצורך בלבד.",
            "לייבש בעדינות בקפלים ולהלביש נוח."
        ]
        tags = "טיפול,ניובורן"

    elif topic == "skin":
        q = f"לתינוק בן {age} יש {random.choice(SKIN)} — מה אפשר לעשות בבית?"
        steps = [
            "עור תינוק רגיש בשבועות הראשונים וזה לרוב חולף.",
            "כותנה, בלי ריחות חזקים, להימנע מחימום יתר.",
            "אם יש החמרה/מוגלה/חום — להתייעץ."
        ]
        tags = "עור,ניובורן"

    elif topic == "diaper_rash":
        q = f"לתינוק בן {age} יש אדמומיות באזור החיתול — מה מומלץ?"
        steps = [
            "החלפות תכופות וייבוש עדין.",
            "אוורור ללא חיתול לכמה דקות כשאפשר.",
            "משחה ייעודית; אם יש פצעים/החמרה — להתייעץ."
        ]
        tags = "עור,חיתולים,ניובורן"

    # אחרי לידה (אמא)
    elif topic == "breast_pain":
        q = f"כואב לי בהנקה מאז הלידה (תינוק בן {age}) — מה יכול לעזור?"
        steps = [
            "לוודא הצמדה ותנוחה; כאב חד ומתמשך לא אמור להיות 'נורמלי'.",
            "לנסות להתחיל בצד הפחות כואב ולהרגיע את העור.",
            "אם יש חום/גוש/פצעים משמעותיים — ייעוץ הנקה/רופא/ה."
        ]
        tags = "הנקה,אחרי לידה"

    elif topic == "engorgement":
        q = "גודש בשדיים בשבוע הראשון אחרי לידה — מה לעשות?"
        steps = [
            "להניק/לשאוב בתדירות גבוהה לפי צורך.",
            "חום קצר לפני ההנקה וקר אחרי יכול להקל.",
            "אם יש חום/אודם מתפשט/כאב חזק — לבדיקה."
        ]
        tags = "הנקה,אחרי לידה"

    elif topic == "mastitis":
        q = "אני אחרי לידה ויש לי גוש כואב בשד עם תחושת חום — מה זה יכול להיות?"
        steps = [
            "זה יכול להיות חסימה או דלקת בשד.",
            "להמשיך לרוקן בעדינות ולנוח ככל האפשר.",
            "אם יש חום/צמרמורות/החמרה מהירה — רופא/ה."
        ]
        tags = "הנקה,אחרי לידה,בריאות"

    elif topic == "post_bleed":
        q = "דימום אחרי לידה (לוכיה) — מה נחשב תקין ומתי לדאוג?"
        steps = [
            "הפרשות אחרי לידה משתנות צבע וכמות בהדרגה.",
            "מנוחה והפחתת מאמץ עוזרות.",
            "אם דימום חזק מאוד/ריח חריף/חום/כאב חריג — בדיקה."
        ]
        tags = "אחרי לידה,בריאות"

    elif topic == "post_mood":
        q = f"אני {random.choice(MOM)} אחרי הלידה — מתי זה 'בייבי בלוז' ומתי צריך עזרה?"
        steps = [
            "תנודות מצב רוח בימים הראשונים נפוצות.",
            "לבקש עזרה, לאכול/לשתות, ולישון כשאפשר.",
            "אם זה נמשך מעל שבועיים או קשה לתפקד — לפנות לעזרה מקצועית."
        ]
        tags = "אחרי לידה,רגש"

    elif topic == "csection":
        q = "אני אחרי קיסרי — איך מתנהלים עם כאבים והחלמה בשבועות הראשונים?"
        steps = [
            "מנוחה, תנועה עדינה, בלי הרמות כבדות.",
            "משככי כאבים רק לפי הנחיית רופא/ה.",
            "אם יש אודם/הפרשה/חום/כאב שמחמיר — בדיקה."
        ]
        tags = "אחרי לידה,החלמה"

    elif topic == "stitches":
        q = "תפרים אחרי לידה רגילה — מה עוזר להקלה ולריפוי?"
        steps = [
            "היגיינה עדינה וייבוש טוב אחרי שטיפה.",
            "קירור קצר וישיבה נוחה יכולים להקל.",
            "אם יש ריח חריף/כאב שמתגבר/חום — בדיקה."
        ]
        tags = "אחרי לידה,החלמה"

    elif topic == "mom_sleep":
        q = "איך אפשר לשרוד חוסר שינה בשבועות הראשונים אחרי לידה?"
        steps = [
            "לישון במקטעים כשגם התינוק ישן.",
            "לבקש עזרה מעשית ולהוריד עומסים.",
            "להוריד ציפיות ולהתמקד בבריאות."
        ]
        tags = "אחרי לידה,שינה,רגש"

    else:  # bottle
        q = f"האכלה מבקבוק לתינוק בן {age} — איך מאכילים לאט כדי להפחית פליטות?"
        steps = [
            "חצי-ישיבה, זרימה איטית, הפסקות קצרות.",
            "גיהוקים במהלך האכלה.",
            "להפסיק כשהתינוק מסמן שובע."
        ]
        tags = "האכלה,בקבוק,ניובורן"

    # מוסיפים הקשר כדי להבטיח ייחודיות בשאלה
    q = clean(f"{q} ({random.choice(CTX)})")
    a = answer(steps)
    return q, a, tags

def main():
    rows = []
    seen_pairs = set()
    seen_q = set()

    while len(rows) < 1000:
        q, a, tags = make_one()
        key = (q, a)
        if key in seen_pairs or q in seen_q:
            continue
        seen_pairs.add(key)
        seen_q.add(q)
        rows.append((q, a, SOURCE, tags))

    # בדיקת כפילויות סופית
    assert len(seen_pairs) == 1000
    assert len(seen_q) == 1000

    out = "qa_rag_1000.csv"
    with open(out, "w", newline="", encoding="utf-8-sig") as f:
        w = csv.writer(f)
        w.writerow(["question","answer","source","tags"])
        w.writerows(rows)

    print("✅ Created:", out)
    print("✅ Rows:", len(rows))

if __name__ == "__main__":
    main()
